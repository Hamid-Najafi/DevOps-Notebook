networks:
  zabbix-network:
    external: true
  traefik-network:
    external: true

volumes:
  zabbix-postgres:
    external: true
  zabbix-confing:
    external: true
  zabbix-modules:
    external: true
  zabbix-tls:
    external: true
  zabbix-snmptraps:
    external: true

services:
  postgres:
    image: ${ZABBIX_POSTGRES_IMAGE_TAG}
    container_name: zabbix-postgres
    volumes:
      - zabbix-postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${ZABBIX_DB_NAME}
      POSTGRES_USER: ${ZABBIX_DB_USER}
      POSTGRES_PASSWORD: ${ZABBIX_DB_PASSWORD}
    networks:
      - zabbix-network
    # ports:
    #   - 5432:5432
    healthcheck:
      test: [ "CMD", "pg_isready", "-q", "-d", "${ZABBIX_DB_NAME}", "-U", "${ZABBIX_DB_USER}" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped


  zabbix-server:
    image: ${ZABBIX_SERVER_IMAGE_TAG}
    container_name: zabbix-server
    environment:
      DB_SERVER_HOST: zabbix-postgres
      DB_SERVER_PORT: 5432
      POSTGRES_DB: ${ZABBIX_DB_NAME}
      POSTGRES_USER: ${ZABBIX_DB_USER}
      POSTGRES_PASSWORD: ${ZABBIX_DB_PASSWORD}
      ZBX_CACHESIZE: ${ZABBIX_CACHESIZE}
      ZBX_SERVER_NAME: ${ZABBIX_SERVER_NAME}
      ZBX_STARTSNMPTRAPPER: 1
      ZBX_STARTIPMIPOLLERS: 3
      ZBX_STARTPINGERS: 10
    networks:
      - zabbix-network
      - traefik-network
    healthcheck:
      test: grep -qr "zabbix_server" /proc/*/status || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      # Enable Traefik for this container
      - "traefik.enable=true"
      # Define TCP router rules for Zabbix to match all incoming requests (HostSNI)
      - "traefik.tcp.routers.zabbix-server-tcp.rule=HostSNI(`*`)"
      # Assign the Zabbix TCP router to a named Traefik service
      - "traefik.tcp.routers.zabbix-server-tcp.service=zabbix-server-tcp"
      # Use the 'zabbix-tcp' (custom) entry point
      - "traefik.tcp.routers.zabbix-server-tcp.entrypoints=zabbix-tcp"
      # Define the internal container port for routing to the Zabbix TCP service
      - "traefik.tcp.services.zabbix-server-tcp.loadbalancer.server.port=10051"
      # Assign the Zabbix UDP router to a named Traefik service
      - "traefik.udp.routers.zabbix-server-udp.service=zabbix-server-udp"
      # Use the 'zabbix-udp' (custom) entry point
      - "traefik.udp.routers.zabbix-server-udp.entrypoints=zabbix-udp"
      # Define the internal container port for routing to the Zabbix UDP service
      - "traefik.udp.services.zabbix-server-udp.loadbalancer.server.port=10051"
      # Specify which Docker network Traefik should use for routing
      - "traefik.docker.network=traefik-network"
    restart: unless-stopped
    volumes:
    # For Logs
      - zabbix-snmptraps:/var/lib/zabbix/snmptraps
      - /etc/localtime:/etc/localtime:ro
      - /docker/zabbix-server/alertscripts:/usr/lib/zabbix/alertscripts:ro
      - /docker/zabbix-server/externalscripts:/usr/lib/zabbix/externalscripts:ro
      - /docker/zabbix-server/dbscripts:/var/lib/zabbix/dbscripts:ro
      - /docker/zabbix-server/export:/var/lib/zabbix/export:rw
      - /docker/zabbix-server/modules:/var/lib/zabbix/modules:ro
      - /docker/zabbix-server/enc:/var/lib/zabbix/enc:ro
      - /docker/zabbix-server/ssh_keys:/var/lib/zabbix/ssh_keys:ro
      - /docker/zabbix-server/mibs:/var/lib/zabbix/mibs:ro
    depends_on:
      postgres:
        condition: service_healthy

  zabbix-dashboard:
    image: ${ZABBIX_WEB_IMAGE_TAG}
    container_name: zabbix-dashboard
    environment:
      DB_SERVER_HOST: zabbix-postgres
      DB_SERVER_PORT: 5432
      POSTGRES_DB: ${ZABBIX_DB_NAME}
      POSTGRES_USER: ${ZABBIX_DB_USER}
      POSTGRES_PASSWORD: ${ZABBIX_DB_PASSWORD}
      ZBX_SERVER_HOST: zabbix-server
      PHP_TZ: ${ZABBIX_TIMEZONE}
    networks:
      - zabbix-network
      - traefik-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    labels:
      # Enable Traefik for this container
      - "traefik.enable=true"
      # Match incoming requests on a specific hostname
      - "traefik.http.routers.zabbix-dashboard.rule=Host(`${ZABBIX_DASHBOARD_HOSTNAME}`)"
      # Assign the router to a named Traefik service
      - "traefik.http.routers.zabbix-dashboard.service=zabbix-dashboard"
      # Use the 'websecure' (HTTPS) entry point
      - "traefik.http.routers.zabbix-dashboard.entrypoints=websecure"
      # Define the internal container port for routing
      - "traefik.http.services.zabbix-dashboard.loadbalancer.server.port=8080"
      # Enable TLS on this router
      - "traefik.http.routers.zabbix-dashboard.tls=true"
      # Use Let's Encrypt for certificate management
      - "traefik.http.routers.zabbix-dashboard.tls.certresolver=letsencrypt"
      # Apply a compression middleware
      - "traefik.http.routers.zabbix-dashboard.middlewares=zabbix-compress"
      # Define settings for the compression middleware
      - "traefik.http.middlewares.zabbix-compress.compress=true"
      # Specify which Docker network Traefik should use for routing
      - "traefik.docker.network=traefik-network"
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      zabbix-server:
        condition: service_healthy

  zabbix-agent:
    image: ${ZABBIX_AGENT_IMAGE_TAG}
    container_name: zabbix-agent
    environment:
      ZBX_HOSTNAME: Zabbix server
      ZBX_SERVER_HOST: zabbix-server
    networks:
      - zabbix-network
    volumes:
      - zabbix-confing:/etc/zabbix/zabbix_agentd.d
      - zabbix-modules:/var/lib/zabbix/modules
      - zabbix-tls:/var/lib/zabbix/enc
    # ports:
    #   - 10050:10050
    restart: unless-stopped
    depends_on:
      - postgres
      - zabbix-server

  zabbix-snmptraps:
    image: ${ZABBIX_SNMPTRAMPS_IMAGE_TAG}
    container_name: zabbix-snmptraps
    ports:
      - "162:162/udp"   # SNMP trap port
    volumes:
    # For Logs
      - zabbix-snmptraps:/var/lib/zabbix/snmptraps  
    networks:
      - zabbix-network
    restart: unless-stopped